@page
@model VNTourLandProject.Pages.Booking.BookingDetailModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Booking-Detail";
}

<style>
    #card-number, #card-expiry, #card-cvc {
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .StripeElement--focus {
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        border-color: #80bdff;
    }

    .StripeElement--invalid {
        border-color: #dc3545;
    }


    .breadcrumb-item.active > a {
        color: white !important;
        opacity: 1 !important;
        text-decoration: none;
    }


</style>


<!-- Navbar & Hero Start -->
<div class="container-fluid position-relative p-0">
    <nav class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
        <a href="" class="navbar-brand p-0">
            <h1 class="m-0">
                <i class="fa-solid fa-at"></i>
                VNTourLand
            </h1>
            <!-- <img src="img/logo.png" alt="Logo"> -->
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
                <a asp-page="/Home/Index" class="nav-item nav-link ">Home</a>
                <a asp-page="/AboutUs/Index" class="nav-item nav-link ">About</a>
                <a asp-page="/TourAndService/Index" class="nav-item nav-link">Tours</a>
                <a asp-page="/SpecialService/Index" class="nav-item nav-link">MICE</a>
                <a asp-page="/RetirementAndCoffee/Index" class="nav-item nav-link">Project</a>
                <a asp-page="/TravelInfo/Index" class="nav-item nav-link">Travel Information Center</a>
                <a asp-page="/ClientsPartners/Index" class="nav-item nav-link">Investors</a>
                <a asp-page="/Contact/Index" class="nav-item nav-link">Contact</a>

                @* <div class="nav-item dropdown"> *@
                @*     <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Pages</a> *@
                @*     <div class="dropdown-menu m-0"> *@
                @*         <a href="destination.html" class="dropdown-item">Destination</a> *@
                @*         <a href="tour.html" class="dropdown-item">Explore Tour</a> *@
                @*         <a href="booking.html" class="dropdown-item">Travel Booking</a> *@
                @*         <a href="gallery.html" class="dropdown-item">Our Gallery</a> *@
                @*         <a href="guides.html" class="dropdown-item">Travel Guides</a> *@
                @*         <a href="testimonial.html" class="dropdown-item">Testimonial</a> *@
                @*         <a href="404.html" class="dropdown-item">404 Page</a> *@
                @*     </div> *@
                @* </div> *@

            </div>
            @if (!Model.isAuth)
            {
                <div class="nav-item dropdown">
                    <a href="#" role="button" class="btn btn-primary rounded-pill py-2 px-4 ms-lg-4 dropdown-toggle" data-bs-toggle="dropdown">More</a>
                    <div class="dropdown-menu m-0">
                        <a asp-page="/Auth/Login" class="dropdown-item">Login</a>
                        <a asp-page="/Auth/Register" class="dropdown-item">Register</a>
                    </div>
                </div>
            }
            else
            {
                <div class="nav-item dropdown">
                    <a href="#" role="button" class="btn btn-primary rounded-pill py-2 px-4 ms-lg-4 dropdown-toggle" data-bs-toggle="dropdown">
                        @Model.UserName
                    </a>
                    <div class="dropdown-menu m-0">

                        <a asp-page="/Profile/Index" class="dropdown-item">Profile</a>

                        <a asp-page="/Manage/MyBooking" class="dropdown-item">My Booking</a>

                        <a asp-page="/Manage/MyTour" class="dropdown-item">My Tour</a>


                        <a asp-page="/Auth/Logout" class="dropdown-item">Logout</a>

                    </div>
                </div>
            }
        </div>
    </nav>
</div>

<!-- Header Start -->
<div class="container-fluid bg-breadcrumb">
    <div class="container text-center py-5" style="max-width: 900px;">
        <h3 class="text-white display-3 mb-4">
            Booking Detail</h1>
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item active"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active text-white"><a href="#">Booking</a></li>
                <li class="breadcrumb-item active text-white">Booking Detail</li>
            </ol>
    </div>
</div>
<!-- Header End -->
<!-- BookingDetail -->
<div class="container my-5">
    <div class="card shadow-lg border-0 rounded-4 p-5 bg-light">
        <h2 class="text-center mb-4 text-primary fw-bold">
            <i class="fa-solid fa-receipt me-2"></i>Booking Information
        </h2>

        <div class="row g-4">
            <!-- Customer Info -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body">
                        <h5 class="fw-bold text-primary mb-3">
                            <i class="fa-solid fa-user me-2"></i>Customer Info
                        </h5>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Full Name:</strong> @Model.Booking.FullName</li>
                            <li><strong>Email:</strong> @Model.Booking.Email</li>
                            <li><strong>Phone:</strong> @Model.Booking.PhoneNumber</li>
                            <li><strong>Address:</strong> @Model.Booking.Address</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tour Info -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body">
                        <h5 class="fw-bold text-success mb-3">
                            <i class="fa-solid fa-map-location-dot me-2"></i>Tour Info
                        </h5>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Tour Name:</strong> @Model.Booking.TourName</li>
                            <li><strong>Booking Date:</strong> @Model.Booking.BookingDate.ToString("dd/MM/yyyy")</li>
                            <li><strong>Adults / Children:</strong> @Model.Booking.NumberOfAdults Adults, @Model.Booking.NumberOfChildren Children</li>
                            <li><strong>Note:</strong> @Model.Booking.Note</li>
                        </ul>
                    </div>
                </div>
            </div>

            @* <!-- Add-On Services --> *@
            @* @if (Model.Booking.AddOnOptions != null && Model.Booking.AddOnOptions.Any()) *@
            @* { *@
            @*     <div class="col-12"> *@
            @*         <div class="card border-0 shadow-sm rounded-4"> *@
            @*             <div class="card-body"> *@
            @*                 <h5 class="fw-bold text-warning mb-3"> *@
            @*                     <i class="fa-solid fa-plus-circle me-2"></i>Additional Services *@
            @*                 </h5> *@
            @*                 <div class="table-responsive"> *@
            @*                     <table class="table table-bordered table-hover mb-0"> *@
            @*                         <thead class="table-light"> *@
            @*                             <tr> *@
            @*                                 <th>Service Name</th> *@
            @*                                 <th class="text-end">Price</th> *@
            @*                             </tr> *@
            @*                         </thead> *@
            @*                         <tbody> *@
            @*                             @foreach (var option in Model.Booking.AddOnOptions) *@
            @*                             { *@
            @*                                 <tr> *@
            @*                                     <td>@option.Name</td> *@
            @*                                     <td class="text-end text-primary fw-semibold">@option.Price.ToString("N0") $</td> *@
            @*                                 </tr> *@
            @*                             } *@
            @*                         </tbody> *@
            @*                     </table> *@
            @*                 </div> *@
            @*             </div> *@
            @*         </div> *@
            @*     </div> *@
            @* } *@
        </div>

        @if (Model.Booking != null && Model.Booking.Status.ToString() == "WAITING_FOR_PAYMENT")
        {
            <div class="text-center mt-5">
                <h5 class="text-dark fw-bold mb-4">🔐 Select Payment Method:</h5>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <form method="post" asp-page-handler="PayWithVNPay">
                        <input type="hidden" name="BookingId" value="@Model.Booking.BookingId" />
                        <button type="submit" class="btn btn-danger btn-lg rounded-pill px-5 shadow">
                            <i class="fa-solid fa-credit-card me-2"></i>Pay with VNPay
                        </button>
                    </form>

                    <form method="post" asp-page-handler="PayWithSepay">
                        <input type="hidden" name="BookingId" value="@Model.Booking.BookingId" />
                        <button type="submit" class="btn btn-success btn-lg rounded-pill px-5 shadow">
                            <i class="fa-solid fa-qrcode me-2"></i>Pay with SEPay QR Code
                        </button>
                    </form>


                    <button type="button" onclick="document.getElementById('stripe-form').classList.toggle('d-none')"
                            class="btn btn-dark btn-lg rounded-pill px-5 shadow">
                        <i class="fa-brands fa-cc-visa me-2"></i>E-Banking
                    </button>
                </div>

                <div id="stripe-form" class="mt-5 d-none">
                    <form method="post" id="stripe-payment-form" class="p-4 border rounded-4 shadow-sm bg-light">
                        <input type="hidden" name="BookingId" value="@Model.Booking.BookingId" />

                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="cardholder-name" class="form-label fw-semibold text-start">Cardholder Name</label>
                                <input type="text" id="cardholder-name" name="CardholderName" class="form-control" placeholder="John Doe" required />
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold text-start">Card Number</label>
                                <div id="card-number" class="form-control py-2"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-start">Expiry Date</label>
                                <div id="card-expiry" class="form-control py-2"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-start">CVC</label>
                                <div id="card-cvc" class="form-control py-2"></div>
                            </div>
                        </div>

                        <div id="card-errors" class="text-danger small mb-3"></div>

                        <div class="d-flex justify-content-end">
                            <button id="stripe-submit" class="btn btn-primary btn-lg rounded-pill px-4 shadow" type="button">
                                <i class="fa-brands fa-cc-visa me-2"></i>Pay with Bank Transfer
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Thông tin chuyển khoản ngân hàng ACB -->
                <div class="mt-5 p-4 border rounded-4 shadow-sm bg-light text-start mx-auto" style="max-width: 500px;">
                    <h5 class="fw-bold mb-3">Bank Transfer Information</h5>
                    <p><strong>Bank:</strong> Asia Commercial Bank (ACB) - Le Quang Dinh Branch, Binh Thanh</p>
                    <p><strong>Account Number:</strong> 13214257</p>
                    <p><strong>Account Holder:</strong> Nguyen Huynh Bao Tri</p>
                    <p><strong>SWIFT Code:</strong> ASCBVNVX</p>
                    <p><strong>Transfer Note:</strong> <span class="text-danger">@Model.Booking.Code</span></p>

                    @* <div class="text-center mt-3"> *@
                    @*     <!-- Replace the QR code URL below with your actual QR code URL --> *@
                    @*     <img src="https://yourdomain.com/path-to-your-qr-code.png" alt="QR Code for bank transfer" style="max-width: 250px; width: 100%;" /> *@
                    @* </div> *@
                </div>

            </div>
        }

        else
        {
            <div class="text-center mt-5">
                <h5 class="text-success fw-bold">This booking has already been paid or is not available for payment.</h5>
            </div>
        }

    </div>
</div>

<!-- Floating Chat Icon Button -->
<div class="position-fixed bottom-0 end-0 mb-3 me-3">
    <button id="chatToggleBtn"
            class="btn btn-primary rounded-circle shadow position-relative"
            style="width: 60px; height: 60px;"
            onclick="toggleChatPanel()">
        <i class="fa fa-comments fs-4"></i>
    </button>
</div>

<!-- Floating Chat Panel -->
<div id="chatBar" class="position-fixed bottom-0 end-0 me-3 mb-3 d-none" style="z-index: 1060;">
    <div class="card shadow-lg rounded-4 overflow-hidden" style="width: 480px; height: 520px;">
        <div class="row g-0 h-100">
            <!-- Customer list -->
            <div class="col-5 border-end bg-white overflow-auto">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light fw-semibold">
                    <span id="floatingChatTitle" class="text-truncate">Select a user to start chatting</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="hideChatPanel()">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <!-- Customer list -->
                <div id="chatCustomerList">
                    @if (Model.ChatCustomers != null && Model.ChatCustomers.Any())
                    {
                        foreach (var customer in Model.ChatCustomers)
                        {
                            <div onclick="openFloatingChat('@customer.UserName', '@customer.UserId')" class="chat-user-item list-group-item list-group-item-action border-0 text-start py-3 px-3">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2" style="width: 36px; height: 36px; font-weight: bold;">
                                        @customer.UserName.Substring(0, 1).ToUpper()
                                    </div>
                                    <span>@customer.UserName</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted p-3">No users to chat with yet</div>
                    }
                </div>
            </div>

            <!-- Chat box -->
            <div class="col-7 d-flex flex-column bg-light position-relative">
                <!-- Messages -->
                <div id="floatingChatContent" class="flex-fill overflow-auto p-3" style="font-size: 14px; max-height: 440px;"></div>

                <!-- Chat input area -->
                <!-- Chat input area -->
                <div id="floatingChatInputArea" class="border-top p-3 bg-white d-none" style="flex-shrink: 0;">
                    <form id="chatForm" enctype="multipart/form-data" onsubmit="return sendFloatingMessageWithImage(event)" class="d-flex align-items-center gap-2">
                        @Html.AntiForgeryToken()

                        <!-- Textarea with padding-right for icons -->
                        <textarea id="floatingMessageInput"
                                  class="form-control flex-grow-1"
                                  placeholder="Type..."
                                  rows="1"
                                  style="
                    resize: none;
                    min-height: 48px;
                    max-height: 120px;
                    padding: 10px 90px 10px 15px;
                    border-radius: 25px;
                    box-shadow: 0 0 5px rgb(0 0 0 / 0.1);
                    border: 1px solid #ccc;
                    font-size: 15px;
                    overflow-y: auto;
                    outline: none;
                  "></textarea>

                        <!-- Icons container -->
                        <div style="position: relative; width: 85px; height: 48px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-left: -85px;">
                            <!-- File upload -->
                            <label for="floatingImageInput" title="Attach Image" style="cursor: pointer; color: #555;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                                    <path d="M8.5 1a3.5 3.5 0 0 0-3.5 3.5v7a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 0-1 0v5.5a1.5 1.5 0 0 1-3 0v-7A2.5 2.5 0 0 1 8.5 2h1a.5.5 0 0 0 0-1h-1z" />
                                </svg>
                            </label>
                            <input type="file" id="floatingImageInput" accept="image/*" style="display:none" />
                            <!-- Send button -->
                            <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; border-radius: 50%; padding: 0; cursor: pointer;" title="Send Message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                    <path d="M15.964 0.686a.5.5 0 0 0-.65-.65L.767 6.767a.5.5 0 0 0-.106.79l6.646 6.646a.5.5 0 0 0 .79-.106l6.853-14.31z" />
                                </svg>
                            </button>
                        </div>
                    </form>
                    <div id="selectedFileName" style="font-size: 12px; color: #555; margin-top: 4px; max-width: 480px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none;"></div>
                </div>



            </div>
        </div>
    </div>
</div>


@Html.AntiForgeryToken()


@section Scripts {
<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>

<script>
    const stripe = Stripe("@Model.StripePublicKey");
    const elements = stripe.elements();

    const style = {
        base: {
            fontSize: "16px",
            color: "#32325d",
            fontFamily: "'Segoe UI', sans-serif",
            "::placeholder": { color: "#aab7c4" }
        },
        invalid: {
            color: "#fa755a",
            iconColor: "#fa755a"
        }
    };

    const cardNumber = elements.create("cardNumber", { style });
    const cardExpiry = elements.create("cardExpiry", { style });
    const cardCvc = elements.create("cardCvc", { style });

    cardNumber.mount("#card-number");
    cardExpiry.mount("#card-expiry");
    cardCvc.mount("#card-cvc");

    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    const submitButton = document.getElementById("stripe-submit");
    const id = { bookingId: "@Model.Booking.BookingId" };

    submitButton.addEventListener("click", async function (e) {
        e.preventDefault();

        const response = await fetch("/Booking/BookingDetail?handler=CreateIntent", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify(id)
        });

        const data = await response.json();

        const result = await stripe.confirmCardPayment(data.clientSecret, {
            payment_method: {
                card: cardNumber
            }
        });

        if (result.error) {
            document.getElementById("card-errors").textContent = result.error.message;
        } else {
            if (result.paymentIntent.status === "succeeded") {
                window.location.href = `/Payment/CallbackStripe?BookingId=${data.bookingId}`;
            }
        }
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    let CURRENT_CHAT_CUSTOMER_ID = null;
    const CURRENT_USER_ID = "@Model.CurrentUserId";

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    connection.start()
        .then(() => console.log("✅ SignalR connected"))
        .catch(err => console.error("❌ SignalR connection failed:", err));

    connection.on("ReceiveMessage", function (senderId, message) {
        const align = senderId === CURRENT_USER_ID ? 'text-end' : 'text-start';
        const color = align === 'text-end' ? 'bg-primary text-white' : 'bg-white border';
        const nameTag = align === 'text-end' ? 'You' : 'Other';

        const chatBar = document.getElementById("chatBar");
        const chat = document.getElementById("floatingChatContent");

        if (!chatBar.classList.contains("d-none") && CURRENT_CHAT_CUSTOMER_ID === senderId) {
            chat.innerHTML += `
                <div class="${align} mb-2">
                    <div class="d-inline-block px-3 py-2 rounded ${color}">${nameTag}: ${message}</div>
                </div>`;
            chat.scrollTop = chat.scrollHeight;
        } else {
            showFloatingNotification("New message", message);
            openFloatingChat("Customer", senderId);

            const chatBtn = document.getElementById("chatToggleBtn");
            if (chatBtn) {
                chatBtn.classList.add("animate__animated", "animate__tada");
                setTimeout(() => chatBtn.classList.remove("animate__animated", "animate__tada"), 1000);
            }
        }
    });

    connection.on("ReceiveChatUser", function (newUserId) {
        fetch("/Booking/BookingDetail?handler=ChatCustomers")
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateChatCustomerList(data.result);
                    const newUser = data.result.find(u => u.userId === newUserId);
                    const name = newUser ? newUser.userName : "Someone";
                    showFloatingNotification("New chat started", `${name} has just sent you a message.`);
                }
            });
    });

    function updateChatCustomerList(users) {
        const container = document.getElementById("chatCustomerList");
        container.innerHTML = "";
        if (!users || users.length === 0) {
            container.innerHTML = `<div class="text-center text-muted p-3">No users to chat with yet</div>`;
            return;
        }
        users.forEach(u => {
            const initial = u.userName?.charAt(0)?.toUpperCase() || "?";
            container.innerHTML += `
                <div onclick="openFloatingChat('${u.userName}', '${u.userId}')"
                    class="chat-user-item list-group-item list-group-item-action border-0 text-start py-3 px-3">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2"
                            style="width: 36px; height: 36px; font-weight: bold;">
                            ${initial}
                        </div>
                        <span>${u.userName}</span>
                    </div>
                </div>`;
        });
    }

    function toggleChatPanel() {
        const panel = document.getElementById("chatBar");
        const isNowVisible = panel.classList.toggle("d-none");
        if (!isNowVisible) {
            const badge = document.getElementById("chatAlertBadge");
            if (badge) badge.remove();
        }
    }

    function hideChatPanel() {
        document.getElementById("chatBar").classList.add("d-none");
        closeFloatingChat();
    }

           async function openFloatingChat(name, customerId) {
                CURRENT_CHAT_CUSTOMER_ID = customerId;
                document.getElementById("floatingChatTitle").innerText = name;

                const chat = document.getElementById("floatingChatContent");
                chat.innerHTML = '<div class="text-muted">Loading messages...</div>';

                try {
                    const res = await fetch(`/Booking/BookingDetail?handler=Chat&customerId=${customerId}`);
                    const data = await res.json();
                    chat.innerHTML = "";

                    if (data.success) {
                        data.result.forEach(m => {
                            const align = m.senderId === CURRENT_USER_ID ? 'text-end' : 'text-start';
                            const color = align === 'text-end' ? 'bg-primary text-white' : 'bg-white border';
                            const nameTag = align === 'text-end' ? 'You' : m.senderName;

                            chat.innerHTML += `<div class="${align} mb-3">`;

                            // Nếu có nội dung văn bản
                            if (m.content) {
                                chat.innerHTML += `
                                    <div class="d-inline-block px-3 py-2 rounded ${color}">
                                        ${nameTag}: ${m.content}
                                    </div>`;
                            }

                            // Nếu có ảnh
                            if (m.imageUrl) {
                                chat.innerHTML += `
                                    <div class="mt-2">
                                        <img src="${m.imageUrl}" class="img-thumbnail" style="max-width: 220px; border-radius: 10px;" />
                                    </div>`;
                            }

                            chat.innerHTML += `</div>`;
                        });

                        chat.scrollTop = chat.scrollHeight;
                        document.getElementById("floatingChatInputArea")?.classList.remove("d-none");
                    } else {
                        chat.innerHTML = `<div class="text-danger">${data.message}</div>`;
                    }
                } catch (e) {
                    chat.innerHTML = `<div class="text-danger">Failed to load chat</div>`;
                }

                document.getElementById("floatingChat").classList.remove("d-none");
                document.getElementById("floatingChatInputArea").classList.remove("d-none");
            }

    function closeFloatingChat() {
        CURRENT_CHAT_CUSTOMER_ID = null;
        document.getElementById("floatingChat").classList.add("d-none");
        document.getElementById("floatingChatInputArea").classList.add("d-none");
        clearFloatingInput();
    }

    function clearFloatingInput() {
        document.getElementById("floatingMessageInput").value = "";
        document.getElementById("selectedFileName").innerText = "";
        document.getElementById("floatingImageInput").value = "";
    }

    async function sendFloatingMessageWithImage(e) {
        e.preventDefault();

        if (!CURRENT_CHAT_CUSTOMER_ID) {
            showFloatingNotification("Warning", "Please select a user to chat with first.");
            return false;
        }

        const messageInput = document.getElementById("floatingMessageInput");
        const message = messageInput.value.trim();
        const fileInput = document.getElementById("floatingImageInput");
        const file = fileInput.files[0];

        if (!message && !file) {
            showFloatingNotification("Warning", "Please enter a message or attach an image.");
            return false;
        }

        const formData = new FormData();
        formData.append("CustomerId", CURRENT_CHAT_CUSTOMER_ID);
        formData.append("Message", message);
        if (file) formData.append("Image", file);

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const res = await fetch("/Booking/BookingDetail?handler=SendChat", {
                method: "POST",
                headers: { "RequestVerificationToken": token },
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                showFloatingNotification("Success", "Message sent.");
                messageInput.value = "";
                fileInput.value = "";
                document.getElementById("selectedFileName").innerText = "";
                  appendFloatingMessage(CURRENT_USER_ID, message || "[Image]", data.imageUrl);

                    connection.invoke("SendMessage", CURRENT_CHAT_CUSTOMER_ID, message);
            } else {
                showFloatingNotification("Error", data.message || "Failed to send message.");
            }
        } catch (err) {
            showFloatingNotification("Error", "Failed to send message.");
        }

        return false;
    }

           function appendFloatingMessage(senderId, message, imageUrl = null) {
            const chat = document.getElementById("floatingChatContent");
            const align = senderId === CURRENT_USER_ID ? 'text-end' : 'text-start';
            const color = align === 'text-end' ? 'bg-primary text-white' : 'bg-white border';
            const nameTag = align === 'text-end' ? 'You' : 'Other';

            let content = `<div class="${align} mb-2">
                <div class="d-inline-block px-3 py-2 rounded ${color}">${nameTag}: ${message}</div>
            </div>`;

            if (imageUrl) {
                content += `<div class="${align} mb-2">
                    <img src="${imageUrl}" class="img-thumbnail" style="max-width: 200px;" />
                </div>`;
            }

            chat.innerHTML += content;
            chat.scrollTop = chat.scrollHeight;
        }


        function showFloatingNotification(title, message) {
                // Xoá toast cũ nếu có
                const oldToast = document.getElementById("chatToast");
                if (oldToast) oldToast.remove();

                // Tạo thông báo
                const toast = document.createElement("div");
                toast.id = "chatToast";
                toast.className = "toast align-items-center text-bg-primary border-0 position-fixed bottom-0 end-0 mb-5 me-3 show";
                toast.style.zIndex = "9999";
                toast.setAttribute("role", "alert");
                toast.setAttribute("aria-live", "assertive");
                toast.setAttribute("aria-atomic", "true");

                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;

                document.body.appendChild(toast);

                // 👉 Thêm icon đỏ vào nút chat nếu chưa có
                const btn = document.getElementById("chatToggleBtn");
                if (btn && !document.getElementById("chatAlertBadge")) {
                    const badge = document.createElement("span");
                    badge.id = "chatAlertBadge";
                    badge.className = "position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle";
                    badge.style.zIndex = "10001";
                    btn.appendChild(badge);
                }

                // Ẩn thông báo sau 5s
                setTimeout(() => {
                    toast.classList.remove("show");
                    toast.remove();
                }, 5000);
                }

    // Display selected file name below input
    document.getElementById("floatingImageInput").addEventListener("change", function () {
        const fileNameContainer = document.getElementById("selectedFileName");
        if (this.files.length > 0) {
            fileNameContainer.innerText = `Selected file: ${this.files[0].name}`;
        } else {
            fileNameContainer.innerText = "";
        }
    });

    // Auto-grow textarea height on input
    document.getElementById("floatingMessageInput").addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    });

</script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Hiển thị thông báo thành công
        @if (TempData["Message"] != null)
        {
            <text>
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: '@TempData["Message"]'
                            });
            </text>
        }

            // Hiển thị thông báo lỗi
        @if (TempData["Error"] != null)
        {
            <text>
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: '@TempData["Error"]'
                            });
            </text>
        }
        });
    </script>
}
